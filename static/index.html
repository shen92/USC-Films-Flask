<!DOCTYPE html>
<html>
  <head>
    <title>HW6</title>
    <style>
      html, body {
        height: 100%;
        max-width: 100%;
        margin: 0;
        font-family: Arial, Helvetica, sans-serif;
        color: red;
        background-color: black;
        overflow-x: hidden;
      }
      body {
        display: flex;
        flex-direction: column;
        margin: 10px;
      }
      #header {
        display: flex;
        flex-direction: row;
      }
      .headerTitle {
        font-size: 25px;
        font-weight: 700;
      }
      .headerGradient {
        flex: 1;
        background: linear-gradient(90deg, rgba(0,0,0,1) 40%, rgba(255,0,0,1) 100%);
      }
      #content{
        display: flex;
        flex: 1;
        flex-direction: row;
        margin-top: 10px;
      }
      #sideBar{
        flex: 1;
        display: flex;
        border-right: 1px solid white;  
      }
      #homeTab {
        display: flex;
        border-bottom: 1px solid white;
        padding: 20px 10px;
        color: red;
        cursor: pointer;
      }
      #searchTab {
        display: flex;
        padding: 20px 10px;
        color: white;
        cursor: pointer;
      }
      #homePage {
        flex: 5;
        height: 100%;
        max-width: 100%;
        display: flex;
        flex-direction: column;
      }
      #searchPage {
        flex: 5;
        height: 100%;
        max-width: 100%;
        display: none;
        flex-direction: column;
      }
      .homeCard {
        width: 80%;
        padding: 20px 0px 80px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .searchForm {
        width: 80%;
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-left: 10px;
        background: linear-gradient(0deg, rgba(0,0,0,1) 0%, rgba(255,0,0,1) 100%);
      }
      .searchTitle{
        margin: 20px 0px;
        font-size: 25px;
        font-weight: 700;
        color: white;
      }
      .searchFormRow{
        width: 40%;
        display: flex;
        margin: 10px 0px;
      }
      .searchFormLabel {
        width: 80px;
        color: white;
      }
      .searchInput {
        height: 20px;
        flex: 1;
        border: none;
        border-radius: 5px;
      }
      .searchDropdown{
        height: 23px;
        flex: 0.4;
        border: none;
        border-radius: 5px;
      }
      .buttonRow {
        justify-content: center;
      }
      .searchButton {
        background-color: black;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 10px 15px;
      }
      .searchButton:hover {
        background-color: darkred;
      }
      #searchPadding {
        margin-left: 10px;
        display: flex; 
        flex: 1;
      }
      #searchResults{
        display: none;
        margin-left: 10px;
        flex-direction: column;
      }
      .resultCard {
        display: none;
        margin: 10px 0px;
      }
      .resultCardInfo{
        margin-left: 40px;
        color: white;
      }
      .resultTitle{
        margin: 25px 0px;
        font-weight: 700;
        font-size: 25px;
        
      }
      .resultYear{
      }
      #notFound{
        margin-left: 10px;
        width: 80%;
        /* display: flex; */
        flex-direction: column;
        display: none; 
        flex: 1;
        color: white;
        align-items: center;
        justify-content: center;
      }
      #footer {
        display: flex;
        flex-direction: column;
        margin-left: 10px;
        padding: 15px 5px;
        background-color: Maroon;
        color: white;
        font-style:italic
      }
      #footer div{
        display: flex;
        flex-direction: row-reverse;
      }
    </style>
    
  </head>
  <body>
      <div id="header">
        <div class="headerTitle">THE MOVIE DB</div>
        <div style="flex: 1"></div>
        <div class="headerGradient"></div>
      </div>
      <div id=content>
          <div id="sideBar">
            <div style="flex: 1"></div>
            <div style="flex: 1">
              <div  id="homeTab" 
                  onclick="onHomeTabClick()" 
                  onmouseover="onHomeTabMouseOver()"
                  onmouseout="onHomeTabMouseOut()"
              >
                <div>Home</div>
                <div style="flex: 1"></div>
                <div>⟶</div>
              </div>
                <div  id="searchTab" 
                    onclick="onSearchTabClick()" 
                    onmouseover="onSearchTabMouseOver()"
                    onmouseout="onSearchTabMouseOut()"
                >
                <div>Search</div>
                <div style="flex: 1"></div>
                <div>⟶</div>
              </div>
            </div>
          </div>

          <div id="homePage">
            <div class="homeCard">
              <div style="color: white">Trending Movies</div>
              <div style="margin-top: 25px;">
                <img id="trendingMovieImage" src="" alt="loading"> 
              </div>
            </div>
            <div class="homeCard">
              <div style="color: white">TV Shows On-Air Today</div>
              <div style="margin-top: 25px;">
                <img id="trendingTVShowImage" src="" alt="loading"> 
              </div>
            </div>
            <div id="footer">
              <div>Designed and developed by Akansha, Pranav & Yash</div>
              <div>Powered by TMDB</div>
            </div>
          </div>

          <div id="searchPage">
            <div id="searchForm" 
                  class="searchForm"
            >
              <div class="searchTitle">Search</div>
              <div class="searchFormRow">
                <div class="searchFormLabel">Keyword<span style="color:red; font-style:italic">*</span></div>
                <input  id="searchInput" 
                        class="searchInput"
                        autocomplete="off" 
                        onchange="onSearchInputChange(this.value)"
                >
              </div>
              <div class="searchFormRow">
                <div class="searchFormLabel">Category<span style="color:red; font-style:italic">*</span></div>
                <select id="searchDropdown" 
                        class="searchDropdown"
                        onchange="onSearchDropdownChange(this.value)">
                  <option></option>
                  <option value="movie">Movies</option>
                  <option value="tv">TV Shows</option>
                  <option value="multi">Movies and TV Shows</option>
                </select>
            </div>
            <div class="searchFormRow buttonRow">
              <button class="searchButton"
                      onclick="onSearchButtonClick()"
              >
                Search
              </button>
              <div style="width: 60px;"></div>
              <button class="searchButton"
                      onclick="onClearButtonClick()"
              >
                Clear
              </button>
            </div>
            </div>

            <div id="notFound">
              <div style="flex: 1"></div>
              <div style="flex: 5">No results found.</div>
            </div>
            <div id="searchResults">
              <div id="searchResultsTitle"style="color: white; padding: 25px 0px">Showing results...</div>
              <div id="resultCard0" class="resultCard">
                <div style="background-color: red; width: 10px"></div>
                <div >
                  <img id="resultPoster0" alt="poster0">
                </div>
                <div class="resultCardInfo">
                  <div id="resultTitle0" class="resultTitle">{title}</div>
                  <div>
                    <span id="resultYear0" class="resultYear">{year}</span> |
                    <span id="resultGenre0">{general_ids}</span>
                  </div>
                  <div>
                    <span>star</span>
                    <span id="resultRate0">{rate}</span>/5
                    <span id="resultVote0">{vote}</span>votes
                  </div>
                  <div id="resultDescription0">{description}</div>
                  <button onclick="onShowMoreButtonClick()">Show more</button>
                </div>
              </div>
              <div id="resultCard1" class="resultCard">
                <div style="background-color: red; width: 10px"></div>
                <div>
                  <img id="resultPoster1" alt="poster1">
                </div>
                <div class="resultCardInfo">
                  <div id="resultTitle1" class="resultTitle">{title}</div>
                  <div>
                    <span id="resultYear1" class="resultYear">{year}</span> |
                    <span id="resultGenre1">{general_ids}</span>
                  </div>
                  <div>
                    <span>star</span>
                    <span id="resultRate1">{rate}</span>/5
                    <span id="resultVote1">{vote}</span>votes
                  </div>
                  <div id="resultDescription1">{description}</div>
                  <button onclick="onShowMoreButtonClick()">Show more</button>
                </div>
              </div>
              <div id="resultCard2" class="resultCard">
                <div style="background-color: red; width: 10px"></div>
                <div>
                  <img id="resultPoster2" alt="poster2">
                </div>
                <div class="resultCardInfo">
                  <div id="resultTitle2" class="resultTitle">{title}</div>
                  <div>
                    <span id="resultYear2" class="resultYear">{year}</span> |
                    <span id="resultGenre2">{general_ids}</span>
                  </div>
                  <div>
                    <span>star</span>
                    <span id="resultRate2">{rate}</span>/5
                    <span id="resultVote2">{vote}</span>votes
                  </div>
                  <div id="resultDescription2">{description}</div>
                  <button onclick="onShowMoreButtonClick()">Show more</button>
                </div>
              </div>
              <div id="resultCard3" class="resultCard">
                <div style="background-color: red; width: 10px"></div>
                <div>
                  <img id="resultPoster3" alt="poster3">
                </div>
                <div class="resultCardInfo">
                  <div id="resultTitle3" class="resultTitle">{title}</div>
                  <div>
                    <span id="resultYear3" class="resultYear">{year}</span> |
                    <span id="resultGenre3">{general_ids}</span>
                  </div>
                  <div>
                    <span>star</span>
                    <span id="resultRate3">{rate}</span>/5
                    <span id="resultVote3">{vote}</span>votes
                  </div>
                  <div id="resultDescription3">{description}</div>
                  <button onclick="onShowMoreButtonClick()">Show more</button>
                </div>
              </div>
              <div id="resultCard4" class="resultCard">
                <div style="background-color: red; width: 10px"></div>
                <div>
                  <img id="resultPoster4" alt="poster4">
                </div>
                <div class="resultCardInfo">
                  <div id="resultTitle4" class="resultTitle">{title}</div>
                  <div>
                    <span id="resultYear4" class="resultYear">{year}</span> |
                    <span id="resultGenre4">{general_ids}</span>
                  </div>
                  <div>
                    <span>star</span>
                    <span id="resultRate4">{rate}</span>/5
                    <span id="resultVote4">{vote}</span>votes
                  </div>
                  <div id="resultDescription4">{description}</div>
                  <button onclick="onShowMoreButtonClick()">Show more</button>
                </div>
              </div>
              <div id="resultCard5" class="resultCard">
                <div style="background-color: red; width: 10px"></div>
                <div>
                  <img id="resultPoster5" alt="poster5">
                </div>
                <div class="resultCardInfo">
                  <div id="resultTitle5" class="resultTitle">{title}</div>
                  <div>
                    <span id="resultYear5" class="resultYear">{year}</span> |
                    <span id="resultGenre5">{general_ids}</span>
                  </div>
                  <div>
                    <span>star</span>
                    <span id="resultRate5">{rate}</span>/5
                    <span id="resultVote5">{vote}</span>votes
                  </div>
                  <div id="resultDescription5">{description}</div>
                  <button onclick="onShowMoreButtonClick()">Show more</button>
                </div>
              </div>
              <div id="resultCard6" class="resultCard">
                <div style="background-color: red; width: 10px"></div>
                <div>
                  <img id="resultPoster6" alt="poster6">
                </div>
                <div class="resultCardInfo">
                  <div id="resultTitle6" class="resultTitle">{title}</div>
                  <div>
                    <span id="resultYear6" class="resultYear">{year}</span> |
                    <span id="resultGenre6">{general_ids}</span>
                  </div>
                  <div>
                    <span>star</span>
                    <span id="resultRate6">{rate}</span>/5
                    <span id="resultVote6">{vote}</span>votes
                  </div>
                  <div id="resultDescription6">{description}</div>
                  <button onclick="onShowMoreButtonClick()">Show more</button>
                </div>
              </div>
              <div id="resultCard7" class="resultCard">
                <div style="background-color: red; width: 10px"></div>
                <div>
                  <img id="resultPoster7" alt="poster7">
                </div>
                <div class="resultCardInfo">
                  <div id="resultTitle7" class="resultTitle">{title}</div>
                  <div>
                    <span id="resultYear7" class="resultYear">{year}</span> |
                    <span id="resultGenre7">{general_ids}</span>
                  </div>
                  <div>
                    <span>star</span>
                    <span id="resultRate7">{rate}</span>/5
                    <span id="resultVote7">{vote}</span>votes
                  </div>
                  <div id="resultDescription7">{description}</div>
                  <button onclick="onShowMoreButtonClick()">Show more</button>
                </div>
              </div>
              <div id="resultCard8" class="resultCard">
                <div style="background-color: red; width: 10px"></div>
                <div>
                  <img id="resultPoster8" alt="poster8">
                </div>
                <div class="resultCardInfo">
                  <div id="resultTitle8" class="resultTitle">{title}</div>
                  <div>
                    <span id="resultYear8" class="resultYear">{year}</span> |
                    <span id="resultGenre8">{general_ids}</span>
                  </div>
                  <div>
                    <span>star</span>
                    <span id="resultRate8">{rate}</span>/5
                    <span id="resultVote8">{vote}</span>votes
                  </div>
                  <div id="resultDescription8">{description}</div>
                  <button onclick="onShowMoreButtonClick()">Show more</button>
                </div>
              </div>
              <div id="resultCard9" class="resultCard">
                <div style="background-color: red; width: 10px"></div>
                <div>
                  <img id="resultPoster9" alt="poster9">
                </div>
                <div class="resultCardInfo">
                  <div id="resultTitle9" class="resultTitle">{title}</div>
                  <div>
                    <span id="resultYear9" class="resultYear">{year}</span> |
                    <span id="resultGenre9">{general_ids}</span>
                  </div>
                  <div>
                    <span>star</span>
                    <span id="resultRate9">{rate}</span>/5
                    <span id="resultVote9">{vote}</span>votes
                  </div>
                  <div id="resultDescription9">{description}</div>
                  <button onclick="onShowMoreButtonClick()">Show more</button>
                </div>
              </div>
            </div>
            <div id="searchPadding"></div>
            <div id="footer">
              <div>Designed and developed by Akansha, Pranav & Yash</div>
              <div>Powered by TMDB</div>
            </div>
          </div>

      </div>
     <script>
       //Node References
       const homeTab = document.getElementById("homeTab");
       const searchTab = document.getElementById("searchTab");
       const homePage = document.getElementById("homePage");
       const searchPage = document.getElementById("searchPage");
       const trendingMovieImage = document.getElementById("trendingMovieImage");
       const trendingTVShowImage = document.getElementById("trendingTVShowImage");
       const searchInput = document.getElementById("searchInput");
       const searchDropdown = document.getElementById("searchDropdown");
       const notFound = document.getElementById("notFound");
       const searchResults = document.getElementById("searchResults");
       const searchResultsTitle = document.getElementById("searchResultsTitle");
       let searchResultCards = [];
       for(let i = 0; i < 10; i++){
         searchResultCards.push(document.getElementById(`resultCard${i}`))
       }
       let resultPosters = [];
       for(let i = 0; i < 10; i++){
         resultPosters.push(document.getElementById(`resultPoster${i}`))
       }
       let resultTitles = [];
       for(let i = 0; i < 10; i++){
        resultTitles.push(document.getElementById(`resultTitle${i}`))
       }
       let resultYears = [];
       for(let i = 0; i < 10; i++){
        resultYears.push(document.getElementById(`resultYear${i}`))
       }
       let resultGenres = [];
       for(let i = 0; i < 10; i++){
        resultGenres.push(document.getElementById(`resultGenre${i}`))
       }
       let resultRates = [];
       for(let i = 0; i < 10; i++){
        resultRates.push(document.getElementById(`resultRate${i}`))
       }
       let resultVotes = [];
       for(let i = 0; i < 10; i++){
        resultVotes.push(document.getElementById(`resultVote${i}`))
       }
       let resultDescriptions = [];
       for(let i = 0; i < 10; i++){
        resultDescriptions.push(document.getElementById(`resultDescription${i}`))
       }
       
      //Configs
      const BASE_URL = "https://shen92moviedb.azurewebsites.net" //Production server
      //const BASE_URL = 'http://localhost:5000'  //Dev server
      const BASE_URL_IMG = 'https://image.tmdb.org/t/p'
      let state = {
        tab: "home",
        homeMovies: [],
        homeTVShows: [],
        //TODO: RESET BEFORE SUBMIT
        keyword: "avengers",
        category: "movie",
        queryResults: [],
        movieGenres: [],
        tvGenres:[]
       }
      
      //Event Handlers
      const onHomeTabClick = () =>{
        state.tab = "home";
        homeTab.style.color = 'red';
        homePage.style.display = 'flex';
        searchTab.style.color = 'white';
        searchPage.style.display = 'none';
        homePageDidMount();
      }

      const onHomeTabMouseOver = () => {
        homeTab.style.color = 'red';
      }

      const onHomeTabMouseOut = () => {
        homeTab.style.color = state.tab === 'home' ? 'red' : 'white';
      }

      const onSearchTabClick = () =>{
        state.tab = "search";
        homeTab.style.color = 'white';
        homePage.style.display = 'none';
        searchTab.style.color = 'red';
        searchPage.style.display = 'flex';
      }

      const onSearchTabMouseOver = () => {
        searchTab.style.color = "red";
      }

      const onSearchTabMouseOut = () => {
        searchTab.style.color = state.tab === 'search' ? 'red' : 'white';
      }

      const onSearchInputChange = (keyword) => {
        const keywords = validateInput(keyword).split(' ').join('%20');
        state.keyword = keywords;
      }

      const onSearchDropdownChange = (category) => {
        state.category = category;
      }

      const onSearchButtonClick = async() => {
        // if(state.keyword === "" || state.category === ""){
        //   alert("Please enter valid values");
        //   return;
        // }
        const queryResults = await fetchQueryResults();
        state.queryResults = queryResults.data;
        await renderQueryResults();
        console.log(state)
      }

      const onClearButtonClick = () => {
        state.keyword ="";
        state.category = "";
        state.queryResults = [];
        searchInput.value = "";
        searchDropdown.selectedIndex = -1;
        //TODO: clear query results
        searchResults.style.display = "none";

      }

      const fetchHomeMovies = async() => {
        const requestOptions = {
          method: 'GET',
          redirect: 'follow'
        };
        try {
          const response = await fetch(`${BASE_URL}/home/movies`, requestOptions);
          return await response.json();
        } catch (error) {
          console.log('Request Failed', error);
        }
      }

      //Helper Functions
      const validateInput = (keyword) => {
        return validKeyword = keyword.replace(/[^a-zA-Z0-9- _]/g, '').replace(/\s+/g, ' ').trim();
      }
      
      const getGenre = (genreIds, mediaType="movie") => {
        let result = [];
        genreIds.forEach(genreId => {
          mediaType === "movie" ? 
            result.push(state.movieGenres.find(genre => genre.id === genreId).name) :
            result.push(state.tvGenres.find(genre => genre.id === genreId).name)
        })
        return result.join(', ')
      } 

      const keepTwoDecimal = (num) => {  
        let result = parseFloat(num);  
        if (isNaN(result)) {   
          return 0.0;  
        }  
        result = Math.round(num * 100) / 100;  
        if(Number.isInteger(result))
          return `${result}.0`
        return result;  
      }

      //API Calls
      const fetchHomeTVShows = async() => {
        const requestOptions = {
          method: 'GET',
          redirect: 'follow'
        };
        try {
          const response = await fetch(`${BASE_URL}/home/tvshows`, requestOptions);
          return await response.json();
        } catch (error) {
          console.log('Request Failed', error);
        }
      }

      const fetchQueryResults = async() => {
        const requestOptions = {
          method: 'GET',
          redirect: 'follow',
        };
        try {
          const response = await fetch(`${BASE_URL}/search/${state.category}?keyword=${state.keyword}`, requestOptions);
          return await response.json();
        } catch (error) {
          console.log('Request Failed', error);
        }
      }
      
      const fetchGenres = async(mediaType="movie") => {
        const requestOptions = {
          method: 'GET',
          redirect: 'follow',
        };
        try {
          const response = await fetch(`${BASE_URL}/genres/${mediaType}`, requestOptions);
          return await response.json();
        } catch (error) {
          console.log('Request Failed', error);
        }
      }

      //Render Functions
      const renderHomeMovieSlide = () =>{
        trendingMovieImage.setAttribute("src", `${BASE_URL_IMG}/w780${state.homeMovies[0].backdrop_path}`)
      }

      const renderHomeTVShowSlide = () => {
        trendingTVShowImage.setAttribute("src", `${BASE_URL_IMG}/w780${state.homeTVShows[0].backdrop_path}`)
      }

      const renderQueryResults = async() => {
        searchResults.style.display = "flex";
        searchResultCards.forEach((searchResultCard, index) => {
          const result = state.queryResults[index];
          searchResultCard.style.display = result == null ? 'none' : 'flex';
          resultPosters[index].setAttribute("src", `${BASE_URL_IMG}/w185${result.poster_path}`)
          resultTitles[index].innerHTML = result.media_type === 'movie' ? result.title : result.name;
          resultYears[index].innerHTML = result.media_type === 'movie' ? result.release_date.substring(0,4) : result.first_air_date.substring(0,4);
          resultGenres[index].innerHTML = result.media_type === 'movie' ? getGenre(result.genre_ids, "movie") : getGenre(result.genre_ids, "tv");
          resultRates[index].innerHTML = keepTwoDecimal(result.vote_average / 2);
          resultVotes[index].innerHTML = result.vote_count;
          resultDescriptions[index].innerHTML = result.overview;
        })
      }

      const homePageDidMount = async() => {
        const homeMovies = await fetchHomeMovies();
        if(homeMovies.data.length !== 0){
          state.homeMovies = homeMovies.data;
        }
        const homeTVShows = await fetchHomeTVShows();
        if(homeTVShows.data.length !== 0){
          state.homeTVShows = homeTVShows.data;
        }
        renderHomeMovieSlide();
        renderHomeTVShowSlide();
        const movieGenres = await fetchGenres('movie')
        if(movieGenres.data.length !== 0){
          state.movieGenres = movieGenres.data;
        }
        const tvGenres = await fetchGenres('tv')
        if(tvGenres.data.length !== 0){
          state.tvGenres = tvGenres.data;
        }
      }

      const searchPageDidMount = () => {
        searchDropdown.selectedIndex = -1;
      }

      homePageDidMount();
      
      searchPageDidMount();
    </script>
  </body>
</html>